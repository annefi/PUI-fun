#!/usr/bin/perl -w

use libhef;


# ----------------------------------------------------------------------------
print "Testing: Reading of data\n";
# ----------------------------------------------------------------------------

# ............................................................................
print "  open file\n";
# ............................................................................

# $res = libhef::a3opencyclefile("/mnt/cdrom/98211.nc");
$res = libhef::a3opencyclefile("/scratch/scr2/hefti/LV1/98006.nc");
print "$res\n";

# ............................................................................
print "  HDF name\n";
# ............................................................................
printf("HDF name: %s\n",libhef::a3hdffn());

# ............................................................................
print "  nc file format version\n";
# ............................................................................
printf("version: %s\n",libhef::a3ncfver());

# ............................................................................
print "  read cycle\n";
# ............................................................................
$res = libhef::a3readcycle();
print "$res\n";

# ............................................................................
print "  expand cycle\n";
# ............................................................................
$res = libhef::a3expand();
print "$res\n";

# ............................................................................
print "  get E/q spec\n";
# ............................................................................
for($i = 0; $i < 60; $i++) {
  $res = libhef::a3xellmmq($i,2.72,0.06,0.06,16.5,2.6,2.6);
  printf("%2.2d %3d\n",$i,$res);
}

# ............................................................................
print "  access DPU Spare: CNQ block\n";
# ............................................................................
$cnq = libhef::a3gcnq();
for($i = 0; $i < 12; $i++) {
  $res = libhef::aget($cnq,$i);
  printf("%2d %10.3f\n",$i,$res);
}
for($i = 12; $i < 15; $i++) {
  $res = libhef::aget($cnq,$i);
  printf("%2d %10.6f\n",$i,$res/34.59577);
}

# ............................................................................
print "  access FSR\n";
# ............................................................................
$fsr = libhef::a3gxfsr();
$res = libhef::asum($fsr,0,60);
printf("  Sum of FSR: %.1f\n",$res);

# ............................................................................
print "  access Matrix Rate 0\n";
# ............................................................................
$mrh_1 = libhef::a3gxmrh_1();
$res   = libhef::asum($mrh_1,0,60);
printf("Sum of MR0: %.1f\n",$res);

# ............................................................................
print "  SWICS E/q Tab\n";
# ............................................................................
for($i = 0; $i < 60; $i++) {
  printf("%3d, ",libhef::a3gxeqtab_i($i));
}
printf("\n");

# ............................................................................
print "  SWIMS E/q Tab\n";
# ............................................................................
$tab = libhef::a3gmeqtab();
for($i = 0; $i < 60; $i++) {
  $res = libhef::aget($tab,$i);
  printf("%3.0f, ",$res);
}
printf("\n");

# ............................................................................
print "  PAPS Level\n";
# ............................................................................
$pal = libhef::a3xpavlev();
printf("PAPS Level: %d\n",$pal);

# ............................................................................
print "  SWIMS E/q Tab\n";
# ............................................................................
$tab = libhef::a3gmeqdpu();
for($i = 0; $i < 60; $i++) {
  $res = libhef::aget($tab,$i);
  printf("%6.2f, ",$res);
}
printf("\n");

printf("50: %6.2f\n",libhef::aget($tab,50));
printf("40: %6.2f\n",libhef::aget($tab,40));
printf("30: %6.2f\n",libhef::aget($tab,30));
printf("20: %6.2f\n",libhef::aget($tab,20));
printf("10: %6.2f\n",libhef::aget($tab,10));

# ............................................................................
print "  close file\n";
# ............................................................................
$res = libhef::a3closecyclefile();
print "$res\n";

# ----------------------------------------------------------------------------
print "Testing: Access of data\n";
# ----------------------------------------------------------------------------

# ............................................................................
print "  E/q according to DPU\n";
# ............................................................................
$res = libhef::adpueoq(0);
print "$res\n";

$res = libhef::adpueoq(1);
print "$res\n";

$res = libhef::adpueoq(59);
print "$res\n";

# ----------------------------------------------------------------------------
print "Testing: Forward Model\n";
# ----------------------------------------------------------------------------
$eoq = libhef::adpueoq(40);
$pav = 22.8;
$moq = 16.0/8.0;
$mas = 16.0;

# ............................................................................
print "  inverted DPU algorithm:\n";
# ............................................................................
$tof = libhef::adputof($eoq,$pav,$moq);
print "$eoq $pav $moq $tof\n";

$esd = libhef::adpuesd($tof,$mas);
print "$tof $esd\n";

# ............................................................................
print "  mass and m/q for these E/q,TOF,ESD, from DPU algorithm:\n";
# ............................................................................
$moq = libhef::adpumoq($eoq,$pav,$tof);
print "$moq\n";

$mas = libhef::adpumas($esd,$tof);
print "$mas\n";

print "  Forward Model: O6+, step 30 (4.904 kV), 22.8 kV)\n";
print "  Expected Result: 374.827 4.1 42.31 5.2\n";
$tmp = libhef::xfm(4.904,22.8,16.0,6.0);
for($i = 0; $i < 4; $i++) {
  printf("%.3f ",libhef::aget($tmp,$i));
}
printf("\n");

$mas = libhef::adpumas($esd,$tof);
print "$mas\n";

# ----------------------------------------------------------------------------
print "Testing: Efficiency model\n";
# ----------------------------------------------------------------------------
$tmp = libhef::xeffv1(160.0,16.0);
print "E: 160 m: 16 eff: $tmp\n";
$tmp = libhef::xeffv1( 48.0,16.0);
print "E:  48 m: 16 eff: $tmp\n";
$tmp = libhef::xeffv1(560.0,56.0);
print "E: 560 m: 56 eff: $tmp\n";
$tmp = libhef::xeffv1(168.0,56.0);
print "E: 168 m: 56 eff: $tmp\n";
